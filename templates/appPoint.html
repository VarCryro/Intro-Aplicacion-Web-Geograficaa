<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Nuevo Predio - Proyecto La Nueva Gloria</title>
    
    <!-- CSS de Bootstrap y Leaflet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Estilo personalizado -->
    <style>
        body { 
            background-color: #f8f9fa; 
        }
        .navbar-brand {
            font-weight: bold;
        }
        /* El mapa ocupará todo el ancho y tendrá una altura fija */
        #map { 
            height: 500px; 
            width: 100%;
            cursor: crosshair; 
            border-radius: 8px; 
            border: 1px solid #ddd;
            margin-bottom: 1.5rem; /* Espacio entre el mapa y el formulario */
        }
        /* Estilo para el contenedor del formulario */
        .form-wrapper { 
            background-color: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
    </style>
</head>
<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">Proyecto La Nueva Gloria</a>
                <a href="index.html" class="btn btn-outline-light">Volver al Inicio</a>
            </div>
        </nav>
    </header>

    <main class="container my-5">
        <div class="text-center mb-4">
            <h1>Agregar un Predio</h1>
            <p class="lead">1. Haz clic en el mapa para seleccionar la ubicación y revelar el formulario.</p>
        </div>
        
        <!-- Contenedor del Mapa (siempre visible) -->
        <div id="map"></div>

        <!-- Contenedor del Formulario (inicialmente oculto) -->
        <div id="form-container" class="form-wrapper" style="display: none;">
            <h4>Detalles del Predio Seleccionado</h4>
            <hr>
            <form id="predioForm" action="/api/add_point" method="POST">
                
                <!-- Campos ocultos para las coordenadas. Se llenan con JavaScript -->
                <input type="hidden" id="latitud" name="latitud" required>
                <input type="hidden" id="longitud" name="longitud" required>

                <!-- Nuevos Campos del Formulario -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nupren" class="form-label">NUPRE (Opcional):</label>
                        <input type="text" id="nupren" name="nupren" class="form-control" placeholder="Número Único de Predio Registral">
                    </div>
                    <div class="col-md-6">
                        <label for="nombre" class="form-label">Nombre del Predio (Opcional):</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" placeholder="Ej: Lote La Esperanza">
                    </div>
                    <div class="col-12">
                        <label for="direccion" class="form-label">Dirección:</label>
                        <input type="text" id="direccion" name="direccion" class="form-control" placeholder="Ej: Calle 10 # 20-30" required>
                    </div>
                     <div class="col-md-6">
                        <label for="estado" class="form-label">Estado (del 1 al 10):</label>
                        <input type="number" id="estado" name="estado" class="form-control" min="1" max="10" placeholder="1" required>
                    </div>
                    <div class="col-md-6">
                        <label for="propietario" class="form-label">Propietario (Opcional):</label>
                        <input type="text" id="propietario" name="propietario" class="form-control" placeholder="Ej: Juan Pérez o Desconocido">
                    </div>
                </div>

                <div class="d-grid mt-4">
                   <button type="submit" class="btn btn-primary btn-lg">Guardar Predio</button>
                </div>
            </form>
        </div>
    </main>
    
    <!-- Scripts de Leaflet y Bootstrap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript para la lógica del mapa y formulario -->
    <script>

        const centroDelBarrio = [4.543, -74.091]; 
        const zoomInicial = 16;

        // 1. Inicializar el mapa
        const map = L.map('map').setView(centroDelBarrio, zoomInicial); 

        // Añadir una capa de OpenStreetMap (el mapa base)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 2. Variables para el marcador y elementos del formulario
        let marker;
        const formContainer = document.getElementById('form-container');
        const latitudInput = document.getElementById('latitud');
        const longitudInput = document.getElementById('longitud');

        // 3. Función que se ejecuta al hacer clic en el mapa
        map.on('click', function(e) {
            const coords = e.latlng;

            // Actualizar los campos ocultos del formulario con las coordenadas
            latitudInput.value = coords.lat.toFixed(6); // Limitar a 6 decimales
            longitudInput.value = coords.lng.toFixed(6);

            // Si no hay un marcador, créalo. Si ya existe, simplemente mueve su posición.
            if (marker) {
                marker.setLatLng(coords);
            } else {
                marker = L.marker(coords).addTo(map)
                    .bindPopup('Ubicación seleccionada').openPopup();
            }

            // Muestra el contenedor del formulario que estaba oculto
            formContainer.style.display = 'block';

            // Opcional: Desplázate hacia el formulario para que sea visible en pantallas pequeñas
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    </script> 
</body>
</html>